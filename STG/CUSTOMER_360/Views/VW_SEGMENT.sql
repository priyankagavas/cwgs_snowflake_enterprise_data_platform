create or replace view DEV_STG.CUSTOMER_360.VW_SEGMENT(
	RVSALES_CWH_ALL_USERS_VIEWED_CONTENT_180_DAYS,
	CONTEXT_PERSONAS_COMPUTATION_KEY,
	RVSALES_CWH_ALL_USERS_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_MOTORIZED_VIEWED_CONTENT_30_DAYS,
	CONTEXT_PERSONAS_COMPUTATION_CLASS,
	RVSALES_CWH_ALL_ASSET_LEAD_SUBMISSIONS_30_DAYS,
	RVSALES_CWH_CLASS_A_GAS_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_TOWABLE_VIEWED_CONTENT_180_DAYS,
	CONTEXT_PERSONAS_COMPUTATION_ID,
	CONTEXT_WAREHOUSES_ALL,
	CONTEXT_WAREHOUSES_WAREHOUSE_IDS,
	HIGH_INTENT_RV_ANON,
	RETAIL_CAMPING_WORLD_WINBACK,
	RVSALES_CWH_CLASS_A_DIESEL_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_TOYHAULER_VIEWED_CONTENT_90_DAYS,
	CONTEXT_PERSONAS_NAMESPACE,
	CWRV_LEAD_FORM_ABANDONERS,
	LTV,
	CONTEXT_LIBRARY_NAME,
	HIGH_INTENT_RV,
	RVSALES_CWH_CLASS_B_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_TRAVEL_TRAILERS_VIEWED_CONTENT_180_DAYS,
	CWRV_FAVORITES_LAST_30_DAYS,
	RVSALES_CWH_FIFTH_WHEEL_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_MOTORIZED_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_TOWABLE_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_TOYHAULER_VIEWED_CONTENT_30_DAYS,
	UUID_TS,
	RVSALES_CWH_CLASS_C_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_CLASS_A_DIESEL_VIEWED_CONTENT_180_DAYS,
	RETAIL_HIGH_INTENT_CUSTOMERS,
	CWRV_LAST_PRODUCT_VIEWED,
	CONTEXT_PERSONAS_SPACE_ID,
	CWRV_FAVORITES_DESC_LAST_14_DAYS,
	CWRV_LEAD_ABANDON,
	RVSALES_CWH_CLASS_C_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_TOWABLE_VIEWED_CONTENT_30_DAYS,
	CWRV_FAVORITES_COUNT_LAST_14_DAYS,
	CWRV_FAVORITES,
	RVSALES_CWH_CLASS_A_DIESEL_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_FIFTH_WHEEL_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_TOYHAULER_VIEWED_CONTENT_180_DAYS,
	CONTEXT_LIBRARY_VERSION,
	RV_TT_VIEW_7_DAYS,
	RVSALES_CWH_ALL_USERS_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_CLASS_A_GAS_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_CLASS_B_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_FIFTH_WHEEL_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_MOTORIZED_VIEWED_CONTENT_90_DAYS,
	CONTEXT_INTEGRATIONS_PERSONAS,
	CWRV_LAST_FAVORITED_STOCK_NUM,
	CWRV_LAST_VIEWED_STOCK_NUM,
	ID,
	RVSALES_CWH_CLASS_A_GAS_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_CLASS_B_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_CLASS_C_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_TRAVEL_TRAILERS_VIEWED_CONTENT_90_DAYS,
	CWRV_FAVS_CHRIS_TEST,
	CWRV_LAST_VIEWED_PRICE,
	EMAIL,
	RECEIVED_AT,
	RVSALES_CWH_ALL_USERS_VIEWED_CONTENT_14_DAYS,
	TYPE_CODES_VIEWS_7_DAYS,
	_2021_ULWRV_SHOW_REGISTRATIONS,
	CUSTOMER_360_HIGH_INTENT_SHOPPER_OVT,
	CUSTOMER_360_HIGH_INTENT_SHOPPER_CW,
	CUSTOMER_360_RV_SHOPPER_TT_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_TT_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_TT_DORMANT,
	CUSTOMER_360_RV_SHOPPER_NEW_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_USED_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_USED_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_NEW_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_USED_DORMANT,
	CUSTOMER_360_RV_SHOPPER_NEW_DORMANT,
	CUSTOMER_360_RV_SHOPPER_FW_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_FW_DORMANT,
	CUSTOMER_360_RV_SHOPPER_FW_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_TC_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_B_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_FD_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_HTT_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_A_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_TTH_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_FD_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_HTT_DORMANT,
	CUSTOMER_360_RV_SHOPPER_PS_DORMANT,
	CUSTOMER_360_RV_SHOPPER_AD_DORMANT,
	CUSTOMER_360_RV_SHOPPER_B_DORMANT,
	CUSTOMER_360_RV_SHOPPER_FD_DORMANT,
	CUSTOMER_360_RV_SHOPPER_C_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_C_DORMANT,
	CUSTOMER_360_RV_SHOPPER_HTT_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_FTH_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_PS_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_CT_DORMANT,
	CUSTOMER_360_RV_SHOPPER_PS_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_AD_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_TC_DORMANT,
	CUSTOMER_360_RV_SHOPPER_A_DORMANT,
	CUSTOMER_360_RV_SHOPPER_AD_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_TC_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_C_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_A_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_TTH_DORMANT,
	CUSTOMER_360_RV_SHOPPER_FTH_DORMANT,
	CUSTOMER_360_RV_SHOPPER_B_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_FTH_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_TTH_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_BTR_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_BTR_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_BTR_DORMANT,
	CSTMR_ID,
	SOURCE_NAME
) as
with ALT as
(
SELECT CSTMR_ID,REPLACE(ALT_ID_VALUE_NBR,'"','') ALT_ID_VALUE_NBR FROM DEV_RAW.EDW_CWH_EDW_DBO.MDM_CSTMR_ALT where ALT_ID_TYPE_CD='SF_ID'
),
SF_USERS AS
(
SELECT U.*,ALT.CSTMR_ID as CSTMR_ID 
FROM DEV_RAW.SEGMENT_PERSONAS.USERS U
JOIN
ALT
ON U.ID = ALT.ALT_ID_VALUE_NBR
WHERE U.ID <> U.EMAIL
),
EMAIL AS
(
SELECT *
FROM DEV_RAW.SEGMENT_PERSONAS.USERS WHERE ID = EMAIL
),
EMAIL_USERS AS
(
SELECT EMAIL.*, E.CSTMR_ID as CSTMR_ID FROM EMAIL
JOIN
DEV_RAW.EDW_CWH_EDW_DBO.MDM_CSTMR_EMAIL E
ON EMAIL.ID = E.EMAIL_ADDR
),
FILTER_CUST_ID as
(
select 	cstmr_id,count(*)from
(select cstmr_id,source_name from
    (
SELECT cstmr_id,'1SF_USERS' as source_name FROM SF_USERS
UNION ALL
SELECT cstmr_id,'2EMAIL_USERS' as source_name FROM EMAIL_USERS
        )
        qualify RANK() OVER ( PARTITION BY cstmr_id ORDER BY  source_name asc) = 1
 )		group by 1        having count(*)>1
 
 )
select 	RVSALES_CWH_ALL_USERS_VIEWED_CONTENT_180_DAYS,
	CONTEXT_PERSONAS_COMPUTATION_KEY,
	RVSALES_CWH_ALL_USERS_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_MOTORIZED_VIEWED_CONTENT_30_DAYS,
	CONTEXT_PERSONAS_COMPUTATION_CLASS,
	RVSALES_CWH_ALL_ASSET_LEAD_SUBMISSIONS_30_DAYS,
	RVSALES_CWH_CLASS_A_GAS_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_TOWABLE_VIEWED_CONTENT_180_DAYS,
	CONTEXT_PERSONAS_COMPUTATION_ID,
	CONTEXT_WAREHOUSES_ALL,
	CONTEXT_WAREHOUSES_WAREHOUSE_IDS,
	HIGH_INTENT_RV_ANON,
	RETAIL_CAMPING_WORLD_WINBACK,
	RVSALES_CWH_CLASS_A_DIESEL_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_TOYHAULER_VIEWED_CONTENT_90_DAYS,
	CONTEXT_PERSONAS_NAMESPACE,
	CWRV_LEAD_FORM_ABANDONERS,
	LTV,
	CONTEXT_LIBRARY_NAME,
	HIGH_INTENT_RV,
	RVSALES_CWH_CLASS_B_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_TRAVEL_TRAILERS_VIEWED_CONTENT_180_DAYS,
	CWRV_FAVORITES_LAST_30_DAYS,
	RVSALES_CWH_FIFTH_WHEEL_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_MOTORIZED_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_TOWABLE_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_TOYHAULER_VIEWED_CONTENT_30_DAYS,
	UUID_TS,
	RVSALES_CWH_CLASS_C_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_CLASS_A_DIESEL_VIEWED_CONTENT_180_DAYS,
	RETAIL_HIGH_INTENT_CUSTOMERS,
	CWRV_LAST_PRODUCT_VIEWED,
	CONTEXT_PERSONAS_SPACE_ID,
	CWRV_FAVORITES_DESC_LAST_14_DAYS,
	CWRV_LEAD_ABANDON,
	RVSALES_CWH_CLASS_C_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_TOWABLE_VIEWED_CONTENT_30_DAYS,
	CWRV_FAVORITES_COUNT_LAST_14_DAYS,
	CWRV_FAVORITES,
	RVSALES_CWH_CLASS_A_DIESEL_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_FIFTH_WHEEL_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_TOYHAULER_VIEWED_CONTENT_180_DAYS,
	CONTEXT_LIBRARY_VERSION,
	RV_TT_VIEW_7_DAYS,
	RVSALES_CWH_ALL_USERS_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_CLASS_A_GAS_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_CLASS_B_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_FIFTH_WHEEL_VIEWED_CONTENT_90_DAYS,
	RVSALES_CWH_MOTORIZED_VIEWED_CONTENT_90_DAYS,
	CONTEXT_INTEGRATIONS_PERSONAS,
	CWRV_LAST_FAVORITED_STOCK_NUM,
	CWRV_LAST_VIEWED_STOCK_NUM,
	ID,
	RVSALES_CWH_CLASS_A_GAS_VIEWED_CONTENT_30_DAYS,
	RVSALES_CWH_CLASS_B_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_CLASS_C_VIEWED_CONTENT_180_DAYS,
	RVSALES_CWH_TRAVEL_TRAILERS_VIEWED_CONTENT_90_DAYS,
	CWRV_FAVS_CHRIS_TEST,
	CWRV_LAST_VIEWED_PRICE,
	EMAIL,
	RECEIVED_AT,
	RVSALES_CWH_ALL_USERS_VIEWED_CONTENT_14_DAYS,
	TYPE_CODES_VIEWS_7_DAYS,
	_2021_ULWRV_SHOW_REGISTRATIONS,
	CUSTOMER_360_HIGH_INTENT_SHOPPER_OVT,
	CUSTOMER_360_HIGH_INTENT_SHOPPER_CW,
	CUSTOMER_360_RV_SHOPPER_TT_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_TT_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_TT_DORMANT,
	CUSTOMER_360_RV_SHOPPER_NEW_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_USED_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_USED_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_NEW_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_USED_DORMANT,
	CUSTOMER_360_RV_SHOPPER_NEW_DORMANT,
	CUSTOMER_360_RV_SHOPPER_FW_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_FW_DORMANT,
	CUSTOMER_360_RV_SHOPPER_FW_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_TC_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_B_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_FD_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_HTT_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_A_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_TTH_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_FD_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_HTT_DORMANT,
	CUSTOMER_360_RV_SHOPPER_PS_DORMANT,
	CUSTOMER_360_RV_SHOPPER_AD_DORMANT,
	CUSTOMER_360_RV_SHOPPER_B_DORMANT,
	CUSTOMER_360_RV_SHOPPER_FD_DORMANT,
	CUSTOMER_360_RV_SHOPPER_C_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_C_DORMANT,
	CUSTOMER_360_RV_SHOPPER_HTT_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_FTH_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_PS_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_CT_DORMANT,
	CUSTOMER_360_RV_SHOPPER_PS_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_AD_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_TC_DORMANT,
	CUSTOMER_360_RV_SHOPPER_A_DORMANT,
	CUSTOMER_360_RV_SHOPPER_AD_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_TC_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_C_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_A_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_TTH_DORMANT,
	CUSTOMER_360_RV_SHOPPER_FTH_DORMANT,
	CUSTOMER_360_RV_SHOPPER_B_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_FTH_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_TTH_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_BTR_PASSIVE,
	CUSTOMER_360_RV_SHOPPER_BTR_ACTIVE,
	CUSTOMER_360_RV_SHOPPER_BTR_DORMANT,
	CSTMR_ID,
	SOURCE_NAME
    from (
SELECT *,'1SF_USERS' as source_name FROM SF_USERS
UNION ALL
SELECT *,'2EMAIL_USERS' as source_name FROM EMAIL_USERS
        )
        where cstmr_id not in (select cstmr_id from FILTER_CUST_ID)
        qualify row_number() OVER ( PARTITION BY cstmr_id ORDER BY  source_name asc) = 1
        ;